const express = require('express');
const http = require('http');
const cors = require('cors');
const { Server } = require('socket.io');
const path = require('path');

const app = express();

// Enable CORS for development, allow all origins.
// For production, restrict 'origin' to your frontend URL for security.
app.use(cors());
app.use(express.json());

const server = http.createServer(app);
const io = new Server(server, {
  cors: {
    origin: "*", 
    methods: ["GET", "POST"]
  }
});

// In-memory data stores (not persistent, just for MVP/testing)
let users = {};
let sessions = {};

// Register a user with a pseudonymous username
app.post('/register', (req, res) => {
  const { username } = req.body;

  // Validate input
  if (!username) {
    return res.status(400).json({ error: "Username is required" });
  }
  
  // Check if username already taken
  if (users[username]) {
    return res.status(400).json({ error: "Username already taken" });
  }
  
  // Register user
  users[username] = { username };
  console.log(`User registered: ${username}`);
  return res.json({ success: true });
});

// Serve privacy page (make sure privacy.html exists in the same directory)
app.get('/privacy', (req, res) => {
  const privacyPath = path.join(__dirname, 'privacy.html');
  res.sendFile(privacyPath, (err) => {
    if (err) {
      console.error('Error sending privacy.html:', err);
      res.status(500).send("Internal Server Error");
    }
  });
});

// Serve mental health resources as simple JSON
app.get('/resources', (req, res) => {
  res.json({
    resources: [
      { title: 'Coping Strategies', content: 'Breathing exercises, journaling...' },
      { title: 'Signs of Crisis', content: 'Reach out to hotlines immediately...' }
    ]
  });
});

// Socket.IO real-time chat handling
io.on('connection', (socket) => {
  console.log(`New socket connection: ${socket.id}`);

  socket.on('joinSession', ({ username }) => {
    if (!username || !users[username]) {
      const errorMsg = 'User not registered.';
      console.error(errorMsg);
      socket.emit('errorMessage', errorMsg);
      return;
    }
    const sessionId = 'session1'; // Static session for MVP; expand as needed
    socket.join(sessionId);
    sessions[socket.id] = { username, sessionId };
    
    // Notify others in the session
    io.to(sessionId).emit('message', { sender: 'system', text: `${username} joined the session.` });
    console.log(`${username} joined session ${sessionId}`);
  });

  socket.on('chatMessage', (msg) => {
    const session = sessions[socket.id];

    if (!session) {
      socket.emit('errorMessage', 'No active session found.');
      return;
    }

    const messageData = { sender: session.username, text: msg };
    io.to(session.sessionId).emit('message', messageData);
    console.log(`Message from ${session.username}: ${msg}`);
  });

  socket.on('disconnect', () => {
    const session = sessions[socket.id];
    if (session && session.username && session.sessionId) {
      io.to(session.sessionId).emit('message', { sender: 'system', text: `${session.username} left the session.` });
      console.log(`User disconnected: ${session.username}`);
      delete sessions[socket.id];
    } else {
      console.log(`Socket disconnected: ${socket.id}`);
    }
  });
});

// Start the server
const PORT = process.env.PORT || 5000;
server.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
