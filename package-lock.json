const express = require('express');
const http = require('http');
const cors = require('cors');
const { Server } = require('socket.io');
const path = require('path');

const app = express();
app.use(cors()); // Allow all origins for now, specify origins in production.
app.use(express.json());

const server = http.createServer(app);
const io = new Server(server, {
  cors: {
    origin: "*", // Replace "*" with your frontend URL in production
    methods: ["GET", "POST"]
  }
});

let users = {};
let sessions = {};

app.post('/register', (req, res) => {
  const { username } = req.body;
  if (!username) {
    res.status(400).json({ error: "Username is required" });
    return;
  }
  if (users[username]) {
    res.status(400).json({ error: "Username already taken" });
    return;
  }
  users[username] = { username };
  console.log(`User registered: ${username}`);
  res.json({ success: true });
});

app.get('/privacy', (req, res) => {
  const privacyPath = path.join(__dirname, 'privacy.html');
  res.sendFile(privacyPath, (err) => {
    if (err) {
      console.error('Error sending privacy.html:', err);
      res.status(500).send("Internal Server Error");
    }
  });
});

app.get('/resources', (req, res) => {
  res.json({
    resources: [
      { title: 'Coping Strategies', content: 'Breathing exercises, journaling...' },
      { title: 'Signs of Crisis', content: 'Reach out to hotlines immediately...' }
    ]
  });
});

io.on('connection', (socket) => {
  console.log(`New socket connection: ${socket.id}`);

  socket.on('joinSession', ({ username }) => {
    if (!username || !users[username]) {
      const errorMsg = 'User not registered.';
      console.error(errorMsg);
      socket.emit('errorMessage', errorMsg);
      return;
    }
    const sessionId = 'session1'; // Static session for MVP only
    socket.join(sessionId);
    sessions[socket.id] = { username, sessionId };
    io.to(sessionId).emit('message', { sender: 'system', text: `${username} joined the session.` });
    console.log(`${username} joined session ${sessionId}`);
  });

  socket.on('chatMessage', (msg) => {
    const session = sessions[socket.id];
    if (!session) {
      socket.emit('errorMessage', 'No active session found.');
      return;
    }
    const messageData = { sender: session.username, text: msg };
    io.to(session.sessionId).emit('message', messageData);
    console.log(`Message from ${session.username}: ${msg}`);
  });

  socket.on('disconnect', () => {
    const session = sessions[socket.id];
    if (session && session.username && session.sessionId) {
      io.to(session.sessionId).emit('message', { sender: 'system', text: `${session.username} left the session.` });
      console.log(`User disconnected: ${session.username}`);
      delete sessions[socket.id];
    } else {
      console.log(`Socket disconnected: ${socket.id}`);
    }
  });
});

const PORT = process.env.PORT || 5000;
server.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
